# CIC_APPROVE – การทำงานของระบบ

## ภาพรวมระบบ

CIC_APPROVE เป็นระบบ Workflow สำหรับอนุมัติเอกสาร CIC แบบหลายขั้นตอน (Multi-Level Approval) โดยลำดับการทำงานจะเริ่มจากผู้สร้างเอกสาร (Requester) และไล่ระดับการอนุมัติไปยัง Manager, CIC Team และ Final Approver ตามลำดับ พร้อมระบบแจ้งเตือนอัตโนมัติทาง Email ทุกครั้งที่มีการเปลี่ยนสถานะ

ระบบทำงานบน ASP.NET MVC เชื่อมต่อฐานข้อมูล SQL Server และใช้ Email Notification เพื่อแจ้งผู้ที่เกี่ยวข้องในแต่ละขั้นตอน

---

# ลำดับการทำงานของระบบ (Workflow)

## 1) Create CIC – ผู้สร้างเอกสาร (Requester)

ผู้ใช้งานเข้าสู่หน้าสร้างเอกสารและดำเนินการดังนี้:

* กรอกข้อมูลหลักของเอกสาร เช่น

  * CIC Type
  * Department
  * Description / Reason
* เพิ่มรายการ Material (Detail)
* แนบไฟล์เอกสารประกอบ
* กด Submit

เมื่อกด Submit ระบบจะดำเนินการดังนี้:

1. บันทึกข้อมูลหลักลงตาราง `trn_CIC`
2. บันทึกรายการ Material ลงตาราง `trn_CICDetail`
3. บันทึกข้อมูลไฟล์แนบลงตาราง `trn_CICAttach`
4. กำหนดสถานะเริ่มต้นเป็น
   **StatusID = 1 (Waiting Manager)**
5. ส่ง Email แจ้ง Manager ให้เข้ามาอนุมัติ

หลังจากนั้นเอกสารจะเข้าสู่สถานะ “รอ Manager อนุมัติ”

---

## 2) Manager Approve

เมื่อ Manager ได้รับ Email และเข้าสู่ระบบ จะสามารถดำเนินการได้ 2 กรณี:

### กรณี Approve

* ระบบเปลี่ยนสถานะเป็น **StatusID = 2 (Waiting CIC)**
* บันทึกชื่อผู้อนุมัติและวันที่อนุมัติ
* ส่ง Email แจ้ง CIC Team ให้ดำเนินการตรวจสอบต่อ

### กรณี Reject

* ระบบเปลี่ยนสถานะเป็น **StatusID = 99 (Reject by Manager)**
* บันทึกเหตุผลการปฏิเสธ
* ส่ง Email กลับไปยังผู้สร้างเอกสาร

---

## 3) CIC Review

CIC Team ทำการตรวจสอบรายละเอียด เช่น:

* ความถูกต้องของข้อมูล
* Material และจำนวน
* เอกสารแนบ

### กรณี Approve

* เปลี่ยนสถานะเป็น **StatusID = 3 (Waiting Final)**
* ส่ง Email แจ้ง Final Approver

### กรณี Reject

* เปลี่ยนสถานะเป็น **StatusID = 98 (Reject by CIC)**
* ส่งกลับไปยัง Manager หรือผู้สร้างเอกสาร

---

## 4) Final Approve

Final Approver ทำการตรวจสอบขั้นสุดท้าย

* หากอนุมัติ → เปลี่ยนสถานะเป็น
  **StatusID = 4 (Completed)**
* ระบบส่ง Email แจ้งว่างานเสร็จสมบูรณ์
* Workflow สิ้นสุดกระบวนการ

---

# การจัดการไฟล์แนบ (Attachment)

* ไฟล์ถูกจัดเก็บในโฟลเดอร์ `/Attach/`
* ระบบบันทึก Path ของไฟล์ลงฐานข้อมูล
* มีการตั้งชื่อไฟล์ใหม่เพื่อป้องกันชื่อซ้ำ
* ผู้ใช้งานสามารถเปิดดูหรือดาวน์โหลดไฟล์จากหน้าเอกสารได้

---

# การแจ้งเตือนทาง Email (Email Notification)

ทุกครั้งที่มีการเปลี่ยนสถานะ ระบบจะ:

1. ตรวจสอบค่า StatusID ปัจจุบัน
2. ดึง Email ของผู้มีสิทธิ์ในขั้นตอนถัดไป
3. สร้าง Subject แบบ Dynamic เช่น
   `MANAGER APPROVE CIC [CIC_ID]`
4. ส่ง Email แจ้งเตือนโดยอัตโนมัติ

Email จึงเป็นกลไกหลักที่ทำให้ Workflow ดำเนินต่อไปในแต่ละขั้นตอน

---

# สรุปการทำงานโดยรวม

1. ผู้สร้างกรอกข้อมูลและส่งเอกสาร
2. ระบบบันทึกข้อมูลและตั้งสถานะเริ่มต้น
3. เอกสารถูกส่งต่อเพื่ออนุมัติตามลำดับขั้น
4. ทุกขั้นตอนมีการอัปเดตสถานะและส่ง Email แจ้งเตือน
5. เมื่อ Final Approve สำเร็จ เอกสารถูกปิดงาน (Completed)

ระบบ CIC_APPROVE จึงทำหน้าที่ควบคุมกระบวนการอนุมัติเอกสารอย่างเป็นลำดับ มีการบันทึกข้อมูลครบถ้วน และสามารถตรวจสอบสถานะย้อนหลังได้ทุกขั้นตอน
